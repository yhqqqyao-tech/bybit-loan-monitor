<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bybitperpmonitor</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        .loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .arbitrage-highlight {
            border: 2px solid #fbbf24 !important;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <!-- Logo -->
            <div class="flex justify-center mb-4 gap-2">
                <!-- P -->
                <svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="logoGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect width="60" height="60" rx="12" fill="url(#logoGrad1)"/>
                    <text x="30" y="43" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="white" text-anchor="middle">P</text>
                </svg>
                
                <!-- E -->
                <svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="logoGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect width="60" height="60" rx="12" fill="url(#logoGrad2)"/>
                    <text x="30" y="43" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="white" text-anchor="middle">E</text>
                </svg>
                
                <!-- R -->
                <svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="logoGrad3" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect width="60" height="60" rx="12" fill="url(#logoGrad3)"/>
                    <text x="30" y="43" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="white" text-anchor="middle">R</text>
                </svg>
                
                <!-- P -->
                <svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="logoGrad4" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect width="60" height="60" rx="12" fill="url(#logoGrad4)"/>
                    <text x="30" y="43" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="white" text-anchor="middle">P</text>
                </svg>
            </div>
            <p class="text-center text-gray-400">实时监控所有支持活期质押借币的币种信息</p>
            
            <!-- 导航按钮组 -->
            <div class="flex justify-center gap-4 mt-4 flex-wrap">
                <a 
                    href="https://app.diffscreen.com/" 
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center space-x-2 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-cyan-500/50"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span>自定义套利差价提醒器</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                </a>
                
                <a 
                    href="https://www.coinglass.com/zh/FundingRate" 
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center space-x-2 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-orange-500/50"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>coinglass资金费对比</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                </a>
            </div>
        </header>

        <div class="mb-6 bg-gradient-to-br from-purple-900/30 to-indigo-900/30 rounded-lg p-6 shadow-lg border border-purple-700/50">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <div>
                        <h2 class="text-2xl font-bold text-purple-400">消息推送配置</h2>
                        <p class="text-sm text-gray-400">支持 WebSocket 和 HTTP Webhook（钉钉、企业微信等），套利机会将自动推送</p>
                    </div>
                </div>
                <div id="wsStatus" class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full bg-gray-500"></div>
                    <span class="text-gray-400 text-sm">未连接</span>
                </div>
            </div>
            
            <div class="space-y-3">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">推送类型</label>
                    <select id="pushType" class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-purple-500 transition-colors">
                        <option value="webhook">HTTP Webhook（钉钉、企业微信等）</option>
                        <option value="websocket">WebSocket</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">推送地址</label>
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            id="wsUrl" 
                            placeholder="https://oapi.dingtalk.com/robot/send?access_token=..." 
                            class="flex-1 bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-purple-500 transition-colors"
                        />
                        <button id="wsConnect" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg transition-colors duration-200 font-semibold">
                            启用
                        </button>
                        <button id="wsDisconnect" class="hidden bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg transition-colors duration-200 font-semibold">
                            停用
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1" id="urlHint">钉钉机器人 Webhook 地址</p>
                </div>
                
                <div id="webhookTypeDiv">
                    <label class="block text-sm text-gray-400 mb-2">Webhook 类型</label>
                    <select id="webhookType" class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-purple-500 transition-colors">
                        <option value="dingtalk">钉钉机器人</option>
                        <option value="wecom">企业微信机器人</option>
                        <option value="feishu">飞书机器人</option>
                        <option value="custom">自定义 JSON</option>
                    </select>
                </div>
                
                <div id="customKeywordDiv">
                    <label class="block text-sm text-gray-400 mb-2">自定义关键词（钉钉安全设置需要）</label>
                    <input 
                        type="text" 
                        id="customKeyword" 
                        placeholder="例如: 警报, 预警, 套利" 
                        class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-purple-500 transition-colors"
                    />
                    <p class="text-xs text-gray-500 mt-1">如果钉钉机器人设置了安全关键词，请在此输入</p>
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">套利提醒阈值（资金费率）</label>
                    <div class="flex items-center space-x-3">
                        <input 
                            type="number" 
                            id="arbitrageThreshold" 
                            value="-0.2" 
                            step="0.1" 
                            min="-10" 
                            max="0" 
                            class="flex-1 bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-purple-500 transition-colors"
                        />
                        <span class="text-gray-400">%</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">只有资金费率达到此阈值或更低时才推送提醒（默认 -0.2%）</p>
                </div>
                
                <div id="wsKeywordDiv" class="hidden">
                    <label class="block text-sm text-gray-400 mb-2">消息关键词（可选）</label>
                    <input 
                        type="text" 
                        id="wsKeyword" 
                        placeholder="例如: arbitrage, alert, notification" 
                        class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-purple-500 transition-colors"
                    />
                </div>
                
                <div id="wsAutoReconnectDiv" class="hidden flex items-center space-x-2">
                    <input type="checkbox" id="wsAutoReconnect" class="w-4 h-4 rounded" checked />
                    <label for="wsAutoReconnect" class="text-sm text-gray-400">自动重连</label>
                </div>
                
                <button id="testPush" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors duration-200 font-semibold">
                    测试推送
                </button>
                
                <div id="wsLog" class="hidden bg-gray-800/50 rounded p-3 max-h-32 overflow-y-auto">
                    <p class="text-xs text-gray-500 mb-1">连接日志:</p>
                    <div id="wsLogContent" class="text-xs text-gray-400 space-y-1"></div>
                </div>
            </div>
        </div>

        <div id="arbitrageAlert" class="hidden mb-6 bg-gradient-to-br from-yellow-900/40 to-orange-900/40 rounded-lg p-6 shadow-lg border-2 border-yellow-500 pulse-animation">
            <div class="flex items-center space-x-3">
                <svg class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-yellow-400 mb-1"⚠️ 套利机会提醒</h3>
                    <p id="arbitrageMessage" class="text-gray-300"></p>
                </div>
                <button id="closeArbitrageAlert" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div id="fundingRateSection" class="mb-6 bg-gradient-to-br from-red-900/30 to-orange-900/30 rounded-lg p-6 shadow-lg border border-red-700/50">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                    </svg>
                    <div>
                        <h2 class="text-2xl font-bold text-red-400">期货负资金费率 TOP 20</h2>
                        <p class="text-sm text-gray-400">8小时累计资金费率最低的币种 (做多可获得资金费)</p>
                    </div>
                </div>
                <div id="fundingRateStatus" class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <span class="text-gray-400 text-sm">加载中...</span>
                </div>
            </div>
            
            <div id="fundingRateLoading" class="flex justify-center items-center py-10">
                <div class="loading"></div>
            </div>
            
            <div id="fundingRateError" class="hidden text-center py-6">
                <p class="text-red-400">加载资金费率失败</p>
            </div>
            
            <div id="fundingRateContainer" class="hidden">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                </div>
            </div>
        </div>

        <div class="mb-6 space-y-4">
            <div class="flex justify-between items-center bg-gray-800 rounded-lg p-4 shadow-lg">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-400">VIP等级:</span>
                        <select id="vipLevel" class="bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-blue-500">
                            <option value="">全部</option>
                            <option value="VIP0">VIP0</option>
                            <option value="VIP1">VIP1</option>
                            <option value="VIP2">VIP2</option>
                            <option value="VIP3">VIP3</option>
                            <option value="VIP4">VIP4</option>
                            <option value="VIP5">VIP5</option>
                            <option value="VIP99">VIP99</option>
                            <option value="PRO1">PRO1</option>
                            <option value="PRO2">PRO2</option>
                            <option value="PRO3">PRO3</option>
                            <option value="PRO4">PRO4</option>
                            <option value="PRO5">PRO5</option>
                            <option value="PRO6">PRO6</option>
                        </select>
                    </div>
                    <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>刷新</span>
                    </button>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="statusIndicator" class="w-3 h-3 rounded-full bg-green-500"></div>
                    <span id="lastUpdate" class="text-gray-400 text-sm">等待加载...</span>
                </div>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-4 shadow-lg">
                <div class="relative">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="搜索币种 (例如: BTC, ETH, USDT...)" 
                        class="w-full bg-gray-700 text-white pl-10 pr-10 py-3 rounded-lg border border-gray-600 focus:outline-none focus:border-blue-500 transition-colors"
                    />
                    <button id="clearSearch" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-colors hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-4 shadow-lg">
                <div class="flex items-center justify-between">
                    <span class="text-gray-400">按活期利率排序:</span>
                    <div class="flex space-x-2">
                        <button id="sortAsc" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2 border border-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"></path>
                            </svg>
                            <span>升序</span>
                        </button>
                        <button id="sortDesc" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2 border border-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h9m5-4v12m0 0l-4-4m4 4l4-4"></path>
                            </svg>
                            <span>降序</span>
                        </button>
                        <button id="sortReset" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2 border border-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span>重置</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingContainer" class="flex justify-center items-center py-20">
            <div class="loading"></div>
        </div>

        <div id="errorContainer" class="hidden bg-red-900/50 border border-red-500 rounded-lg p-6 mb-6">
            <div class="flex items-center space-x-2 mb-2">
                <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="text-xl font-semibold text-red-400">加载错误</h3>
            </div>
            <p id="errorMessage" class="text-gray-300"></p>
        </div>

        <div id="statsContainer" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg p-6 shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-200 text-sm">总币种数</p>
                        <p id="totalCoins" class="text-3xl font-bold mt-1">0</p>
                    </div>
                    <svg class="w-12 h-12 text-blue-300 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
            <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-lg p-6 shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-200 text-sm">支持活期借币</p>
                        <p id="flexibleCoins" class="text-3xl font-bold mt-1">0</p>
                    </div>
                    <svg class="w-12 h-12 text-green-300 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
            <div class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-lg p-6 shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-200 text-sm">支持定期借币</p>
                        <p id="fixedCoins" class="text-3xl font-bold mt-1">0</p>
                    </div>
                    <svg class="w-12 h-12 text-purple-300 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <div id="dataContainer" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>
    </div>

    <script>
        let updateInterval;
        let fundingRateInterval;
        let allCoinsData = [];
        let fundingRateData = [];
        let currentSortOrder = null;
        let lastArbitrageCoins = new Set();
        let lastHighFundingCoins = new Set();
        let ws = null;
        let wsReconnectTimer = null;
        let pushEnabled = false;
        let wsConfig = {
            type: 'webhook',
            url: '',
            keyword: '',
            customKeyword: '',
            autoReconnect: true,
            webhookType: 'dingtalk'
        };
        let arbitrageThreshold = -0.2;
        const API_BASE = 'https://api.bybit.com';
        const UPDATE_INTERVAL = 60000;
        
        function playNotificationSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
            
            setTimeout(() => {
                const oscillator2 = audioContext.createOscillator();
                const gainNode2 = audioContext.createGain();
                
                oscillator2.connect(gainNode2);
                gainNode2.connect(audioContext.destination);
                
                oscillator2.frequency.value = 1000;
                oscillator2.type = 'sine';
                
                gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator2.start(audioContext.currentTime);
                oscillator2.stop(audioContext.currentTime + 0.5);
            }, 200);
        }
        
        function wsLog(message, type = 'info') {
            const logDiv = document.getElementById('wsLog');
            const logContent = document.getElementById('wsLogContent');
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            const colorClass = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-gray-400';
            
            logDiv.classList.remove('hidden');
            const logEntry = document.createElement('div');
            logEntry.className = colorClass;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContent.appendChild(logEntry);
            
            if (logContent.children.length > 10) {
                logContent.removeChild(logContent.firstChild);
            }
            
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function updateWsStatus(status, color) {
            const statusDiv = document.getElementById('wsStatus');
            statusDiv.innerHTML = `
                <div class="w-3 h-3 rounded-full bg-${color}-500"></div>
                <span class="text-gray-400 text-sm">${status}</span>
            `;
        }
        
        function connectWebSocket() {
            const url = document.getElementById('wsUrl').value.trim();
            const pushType = document.getElementById('pushType').value;
            const keyword = document.getElementById('wsKeyword').value.trim();
            const customKeyword = document.getElementById('customKeyword').value.trim();
            const autoReconnect = document.getElementById('wsAutoReconnect').checked;
            const webhookType = document.getElementById('webhookType').value;
            
            if (!url) {
                wsLog('请输入推送地址', 'error');
                return;
            }
            
            wsConfig.type = pushType;
            wsConfig.url = url;
            wsConfig.keyword = keyword;
            wsConfig.customKeyword = customKeyword;
            wsConfig.autoReconnect = autoReconnect;
            wsConfig.webhookType = webhookType;
            
            if (pushType === 'webhook') {
                pushEnabled = true;
                wsLog('Webhook 推送已启用', 'success');
                updateWsStatus('已启用', 'green');
                document.getElementById('wsConnect').classList.add('hidden');
                document.getElementById('wsDisconnect').classList.remove('hidden');
                document.getElementById('wsUrl').disabled = true;
                document.getElementById('pushType').disabled = true;
                document.getElementById('webhookType').disabled = true;
                return;
            }
            
            try {
                ws = new WebSocket(url);
                
                ws.onopen = () => {
                    pushEnabled = true;
                    wsLog('WebSocket 连接成功', 'success');
                    updateWsStatus('已连接', 'green');
                    document.getElementById('wsConnect').classList.add('hidden');
                    document.getElementById('wsDisconnect').classList.remove('hidden');
                    document.getElementById('wsUrl').disabled = true;
                    document.getElementById('pushType').disabled = true;
                };
                
                ws.onmessage = (event) => {
                    wsLog(`收到消息: ${event.data}`, 'info');
                };
                
                ws.onerror = (error) => {
                    wsLog('连接错误', 'error');
                    updateWsStatus('连接错误', 'red');
                };
                
                ws.onclose = () => {
                    pushEnabled = false;
                    wsLog('连接已关闭', 'error');
                    updateWsStatus('未连接', 'gray');
                    document.getElementById('wsConnect').classList.remove('hidden');
                    document.getElementById('wsDisconnect').classList.add('hidden');
                    document.getElementById('wsUrl').disabled = false;
                    document.getElementById('pushType').disabled = false;
                    
                    if (wsConfig.autoReconnect && wsConfig.url && wsConfig.type === 'websocket') {
                        wsLog('将在10秒后重连...', 'info');
                        wsReconnectTimer = setTimeout(() => {
                            connectWebSocket();
                        }, 10000);
                    }
                };
                
                updateWsStatus('连接中...', 'yellow');
                
            } catch (error) {
                wsLog(`连接失败: ${error.message}`, 'error');
                updateWsStatus('连接失败', 'red');
            }
        }
        
        function disconnectWebSocket() {
            if (wsReconnectTimer) {
                clearTimeout(wsReconnectTimer);
                wsReconnectTimer = null;
            }
            
            pushEnabled = false;
            
            if (ws) {
                wsConfig.autoReconnect = false;
                ws.close();
                ws = null;
                wsLog('已断开 WebSocket 连接', 'info');
            } else {
                wsLog('已停用 Webhook 推送', 'info');
            }
            
            updateWsStatus('未连接', 'gray');
            document.getElementById('wsConnect').classList.remove('hidden');
            document.getElementById('wsDisconnect').classList.add('hidden');
            document.getElementById('wsUrl').disabled = false;
            document.getElementById('pushType').disabled = false;
            document.getElementById('webhookType').disabled = false;
        }
        
        async function sendWebhook(message) {
            if (!pushEnabled || !wsConfig.url) return false;
            
            try {
                let payload;
                let fullMessage = message;
                
                if (wsConfig.customKeyword) {
                    fullMessage = `${wsConfig.customKeyword} ${message}`;
                }
                
                switch (wsConfig.webhookType) {
                    case 'dingtalk':
                        payload = {
                            msgtype: 'text',
                            text: {
                                content: fullMessage
                            }
                        };
                        break;
                    
                    case 'wecom':
                        payload = {
                            msgtype: 'text',
                            text: {
                                content: fullMessage
                            }
                        };
                        break;
                    
                    case 'feishu':
                        payload = {
                            msg_type: 'text',
                            content: {
                                text: fullMessage
                            }
                        };
                        break;
                    
                    case 'custom':
                        payload = wsConfig.keyword ? 
                            { keyword: wsConfig.keyword, message: fullMessage } : 
                            { message: fullMessage };
                        break;
                }
                
                wsLog(`发送数据: ${JSON.stringify(payload)}`, 'info');
                
                // 使用 Cloudflare Worker 转发请求以解决 CORS 问题
                const workerUrl = 'https://dingtalk-webhook-proxy.yhqqqyao.workers.dev/';
                
                const response = await fetch(workerUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: wsConfig.url,
                        payload: payload
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.errcode === 0) {
                        wsLog(`钉钉推送成功`, 'success');
                        return true;
                    } else {
                        wsLog(`钉钉返回错误: ${result.errmsg || result.errcode}`, 'error');
                        return false;
                    }
                } else {
                    wsLog(`HTTP 错误: ${response.status} ${response.statusText}`, 'error');
                    return false;
                }
            } catch (error) {
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    wsLog(`浏览器 CORS 限制，请使用服务器端转发或部署到 GitHub Pages`, 'error');
                } else {
                    wsLog(`Webhook 推送错误: ${error.message}`, 'error');
                }
                return false;
            }
        }
        
        function sendWebSocketMessage(message) {
            if (!pushEnabled) return false;
            
            if (wsConfig.type === 'webhook') {
                return sendWebhook(message);
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                try {
                    const payload = wsConfig.keyword ? 
                        JSON.stringify({ keyword: wsConfig.keyword, message: message }) : 
                        message;
                    
                    ws.send(payload);
                    wsLog(`WebSocket 发送成功`, 'success');
                    return true;
                } catch (error) {
                    wsLog(`WebSocket 发送失败: ${error.message}`, 'error');
                    return false;
                }
            }
            return false;
        }

        async function fetchLoanData(vipLevel = '') {
            try {
                const params = new URLSearchParams();
                if (vipLevel) {
                    params.append('vipLevel', vipLevel);
                }
                
                const url = `${API_BASE}/v5/crypto-loan-common/loanable-data${params.toString() ? '?' + params.toString() : ''}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.retCode !== 0) {
                    throw new Error(data.retMsg || '未知错误');
                }
                
                return data.result.list || [];
            } catch (error) {
                console.error('获取数据失败:', error);
                throw error;
            }
        }

        function formatRate(rate) {
            if (!rate || rate === '') return 'N/A';
            return (parseFloat(rate) * 100).toFixed(4) + '%';
        }
        
        function calculateHourlyRate(annualRate) {
            if (!annualRate || annualRate === '') return 'N/A';
            const hourlyRate = parseFloat(annualRate) / 365 / 24;
            return (hourlyRate * 100).toFixed(8) + '%';
        }
        
        async function fetchAllTickers() {
            try {
                const response = await fetch(`${API_BASE}/v5/market/tickers?category=linear`);
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                const data = await response.json();
                if (data.retCode !== 0) {
                    throw new Error(data.retMsg || '未知错误');
                }
                return data.result.list || [];
            } catch (error) {
                console.error('获取Tickers失败:', error);
                throw error;
            }
        }
        
        async function fetchFundingRates() {
            try {
                const tickers = await fetchAllTickers();
                const fundingRates = tickers
                    .filter(ticker => ticker.fundingRate && parseFloat(ticker.fundingRate) < 0)
                    .map(ticker => {
                        const fundingRate = parseFloat(ticker.fundingRate);
                        // 获取实际的资金费率结算周期（小时）
                        const fundingInterval = parseFloat(ticker.fundingIntervalHour || 8);
                        // 将资金费率标准化为8小时周期，便于比较
                        const rate8h = fundingRate * (8 / fundingInterval);
                        
                        return {
                            symbol: ticker.symbol,
                            fundingRate: fundingRate,
                            fundingInterval: fundingInterval,
                            rate8h: rate8h,
                            lastPrice: ticker.lastPrice,
                            price24hPcnt: ticker.price24hPcnt
                        };
                    })
                    .sort((a, b) => a.rate8h - b.rate8h)
                    .slice(0, 20);
                
                return fundingRates;
            } catch (error) {
                console.error('获取资金费率失败:', error);
                throw error;
            }
        }
        
        function renderFundingRateCard(item, index) {
            const rate8hPercent = (item.rate8h * 100).toFixed(4);
            const actualRatePercent = (item.fundingRate * 100).toFixed(4);
            const priceChange = (parseFloat(item.price24hPcnt) * 100).toFixed(2);
            const priceChangeClass = parseFloat(priceChange) >= 0 ? 'text-green-400' : 'text-red-400';
            const priceChangeSign = parseFloat(priceChange) >= 0 ? '+' : '';
            
            const arbitrageBadge = item.isArbitrage ? 
                '<span class="ml-2 px-2 py-1 bg-yellow-500 text-gray-900 text-xs font-bold rounded">套利</span>' : '';
            
            // 显示实际结算周期
            const intervalText = item.fundingInterval === 8 ? '8h' : `${item.fundingInterval}h`;
            
            return `
                <div class="bg-gray-800 rounded-lg p-4 hover:bg-gray-750 transition-colors duration-200 ${item.isArbitrage ? 'arbitrage-highlight' : ''}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <span class="text-gray-400 text-sm">#${index + 1}</span>
                            <span class="ml-2 text-white font-bold text-lg">${item.symbol.replace('USDT', '')}</span>
                            ${arbitrageBadge}
                        </div>
                    </div>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">8h累计费率:</span>
                            <span class="text-red-400 font-semibold">${rate8hPercent}%</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">实际费率(${intervalText}):</span>
                            <span class="text-orange-400 text-sm">${actualRatePercent}%</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">价格:</span>
                            <span class="text-white text-sm">$${parseFloat(item.lastPrice).toFixed(3)}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">24h:</span>
                            <span class="${priceChangeClass} text-sm font-semibold">${priceChangeSign}${priceChange}%</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderFundingRates(data) {
            const container = document.getElementById('fundingRateContainer');
            const loadingContainer = document.getElementById('fundingRateLoading');
            const errorContainer = document.getElementById('fundingRateError');
            const statusContainer = document.getElementById('fundingRateStatus');
            
            loadingContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
            
            if (data.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-6 text-gray-400">暂无负资金费率币种</div>';
            } else {
                container.querySelector('.grid').innerHTML = data.map((item, index) => renderFundingRateCard(item, index)).join('');
            }
            
            container.classList.remove('hidden');
            
            statusContainer.innerHTML = `
                <div class="w-3 h-3 rounded-full bg-green-500"></div>
                <span class="text-gray-400 text-sm">最后更新: ${new Date().toLocaleTimeString('zh-CN')}</span>
            `;
        }
        
        function showFundingRateError() {
            const loadingContainer = document.getElementById('fundingRateLoading');
            const errorContainer = document.getElementById('fundingRateError');
            const container = document.getElementById('fundingRateContainer');
            const statusContainer = document.getElementById('fundingRateStatus');
            
            loadingContainer.classList.add('hidden');
            container.classList.add('hidden');
            errorContainer.classList.remove('hidden');
            
            statusContainer.innerHTML = `
                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                <span class="text-gray-400 text-sm">加载失败</span>
            `;
        }
        
        function checkArbitrageOpportunities(fundingRates, loanCoins) {
            const loanCoinSymbols = new Set(loanCoins.map(coin => coin.currency));
            const arbitrageCoins = [];
            const threshold = parseFloat(document.getElementById('arbitrageThreshold').value) / 100;
            
            fundingRates.forEach(item => {
                const coinSymbol = item.symbol.replace('USDT', '');
                const fundingRate = parseFloat(item.fundingRate);
                
                if (loanCoinSymbols.has(coinSymbol)) {
                    item.isArbitrage = true;
                    
                    if (fundingRate <= threshold) {
                        arbitrageCoins.push({
                            symbol: coinSymbol,
                            rate: fundingRate
                        });
                    }
                }
            });
            
            return arbitrageCoins;
        }
        
        function checkHighFundingRates(fundingRates) {
            const highFundingCoins = [];
            const highThreshold = 0.02; // 2%的8小时累计费率绝对值
            
            fundingRates.forEach(item => {
                const rate8h = parseFloat(item.rate8h);
                
                // 检查8小时累计费率绝对值是否大于2%
                if (Math.abs(rate8h) > highThreshold) {
                    const coinSymbol = item.symbol.replace('USDT', '');
                    highFundingCoins.push({
                        symbol: coinSymbol,
                        rate8h: rate8h,
                        fundingRate: item.fundingRate,
                        fundingInterval: item.fundingInterval
                    });
                }
            });
            
            return highFundingCoins;
        }
        
        function showArbitrageAlert(coins) {
            const coinSymbols = coins.map(c => c.symbol);
            const currentCoinsSet = new Set(coinSymbols);
            
            // 找出新出现的币种（之前不在列表中，现在出现了）
            const newCoins = coins.filter(coin => !lastArbitrageCoins.has(coin.symbol));
            
            // 找出重新出现的币种（之前消失了，现在又出现了）
            // 这些币种在上一次检测时不存在，但在更早之前存在过
            const reappearedCoins = newCoins.filter(coin => {
                // 如果是完全新的币种，不算重新出现
                return lastArbitrageCoins.size > 0;
            });
            
            // 需要推送的条件：有新币种出现
            if (newCoins.length > 0) {
                playNotificationSound();
                
                const alertDiv = document.getElementById('arbitrageAlert');
                const messageDiv = document.getElementById('arbitrageMessage');
                
                const threshold = parseFloat(document.getElementById('arbitrageThreshold').value);
                const coinDetails = coins.map(c => `${c.symbol}(${(c.rate * 100).toFixed(4)}%)`).join(', ');
                
                let message;
                if (coins.length === newCoins.length) {
                    // 所有都是新机会
                    message = `发现 ${coins.length} 个套利机会！资金费率低于 ${threshold}%，同时支持借币：${coinDetails}`;
                } else {
                    // 有新增的机会
                    const newCoinDetails = newCoins.map(c => `${c.symbol}(${(c.rate * 100).toFixed(4)}%)`).join(', ');
                    message = `新增 ${newCoins.length} 个套利机会！${newCoinDetails}。当前共 ${coins.length} 个机会：${coinDetails}`;
                }
                
                messageDiv.textContent = message;
                alertDiv.classList.remove('hidden');
                
                sendWebSocketMessage(message);
            }
            
            // 更新记录：只保存当前存在的套利币种
            lastArbitrageCoins = currentCoinsSet;
        }
        
        function showHighFundingAlert(coins) {
            const coinSymbols = coins.map(c => c.symbol);
            const currentCoinsSet = new Set(coinSymbols);
            
            // 找出新出现的高资金费币种
            const newCoins = coins.filter(coin => !lastHighFundingCoins.has(coin.symbol));
            
            // 需要推送的条件：有新币种出现
            if (newCoins.length > 0) {
                playNotificationSound();
                
                const alertDiv = document.getElementById('arbitrageAlert');
                const messageDiv = document.getElementById('arbitrageMessage');
                
                const coinDetails = coins.map(c => {
                    const rate8hPercent = (c.rate8h * 100).toFixed(4);
                    const actualRatePercent = (c.fundingRate * 100).toFixed(4);
                    return `${c.symbol}(8h累计:${rate8hPercent}%, ${c.fundingInterval}h费率:${actualRatePercent}%)`;
                }).join(', ');
                
                let message;
                if (coins.length === newCoins.length) {
                    // 所有都是新的高资金费
                    message = `⚠️ 高资金费预警！发现 ${coins.length} 个币种8h累计费率绝对值超过2%：${coinDetails}`;
                } else {
                    // 有新增的高资金费
                    const newCoinDetails = newCoins.map(c => {
                        const rate8hPercent = (c.rate8h * 100).toFixed(4);
                        return `${c.symbol}(${rate8hPercent}%)`;
                    }).join(', ');
                    message = `⚠️ 高资金费预警！新增 ${newCoins.length} 个币种：${newCoinDetails}。当前共 ${coins.length} 个高费率币种`;
                }
                
                messageDiv.textContent = message;
                alertDiv.classList.remove('hidden');
                
                sendWebSocketMessage(message);
            }
            
            // 更新记录：只保存当前存在的高资金费币种
            lastHighFundingCoins = currentCoinsSet;
        }
        
        async function updateFundingRates() {
            try {
                const data = await fetchFundingRates();
                fundingRateData = data;
                
                // 检查高资金费率（不需要借币列表）
                const highFundingCoins = checkHighFundingRates(data);
                if (highFundingCoins.length > 0) {
                    showHighFundingAlert(highFundingCoins);
                }
                
                // 检查套利机会（需要借币列表）
                if (allCoinsData.length > 0) {
                    const arbitrageCoins = checkArbitrageOpportunities(data, allCoinsData);
                    if (arbitrageCoins.length > 0) {
                        showArbitrageAlert(arbitrageCoins);
                    }
                }
                
                renderFundingRates(data);
            } catch (error) {
                showFundingRateError();
            }
        }

        function renderCoinCard(coin) {
            const flexibleRate = formatRate(coin.flexibleAnnualizedInterestRate);
            const hourlyRate = calculateHourlyRate(coin.flexibleAnnualizedInterestRate);
            const hasFixedRates = coin.annualizedInterestRate7D || coin.annualizedInterestRate14D || 
                                   coin.annualizedInterestRate30D || coin.annualizedInterestRate60D || 
                                   coin.annualizedInterestRate90D || coin.annualizedInterestRate180D;

            return `
                <div class="bg-gray-800 rounded-lg p-6 shadow-lg hover:shadow-2xl transition-shadow duration-300 fade-in border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold text-blue-400">${coin.currency}</h3>
                        <span class="px-3 py-1 bg-blue-600 rounded-full text-sm">${coin.vipLevel || 'N/A'}</span>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex items-center space-x-2">
                            <span class="w-3 h-3 rounded-full ${coin.flexibleBorrowable ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span class="text-gray-400">活期借币:</span>
                            <span class="font-semibold">${coin.flexibleBorrowable ? '支持' : '不支持'}</span>
                        </div>
                        
                        ${coin.flexibleBorrowable ? `
                            <div class="bg-gray-700 rounded p-3 space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">活期年化利率:</span>
                                    <span class="text-green-400 font-semibold">${flexibleRate}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">小时利率:</span>
                                    <span class="text-cyan-400 font-semibold">${hourlyRate}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">最小借币量:</span>
                                    <span class="font-semibold">${coin.minFlexibleBorrowingAmount}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">精度:</span>
                                    <span class="font-semibold">${coin.flexibleBorrowingAccuracy}</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="flex items-center space-x-2 mt-3">
                            <span class="w-3 h-3 rounded-full ${coin.fixedBorrowable ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span class="text-gray-400">定期借币:</span>
                            <span class="font-semibold">${coin.fixedBorrowable ? '支持' : '不支持'}</span>
                        </div>
                        
                        ${coin.fixedBorrowable ? `
                            <div class="bg-gray-700 rounded p-3 space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">最小借币量:</span>
                                    <span class="font-semibold">${coin.minFixedBorrowingAmount}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">精度:</span>
                                    <span class="font-semibold">${coin.fixedBorrowingAccuracy}</span>
                                </div>
                                ${hasFixedRates ? `
                                    <div class="mt-2 pt-2 border-t border-gray-600">
                                        <p class="text-gray-400 text-sm mb-2">定期年化利率:</p>
                                        <div class="grid grid-cols-2 gap-2 text-sm">
                                            ${coin.annualizedInterestRate7D ? `<div><span class="text-gray-400">7天:</span> <span class="text-purple-400">${formatRate(coin.annualizedInterestRate7D)}</span></div>` : ''}
                                            ${coin.annualizedInterestRate14D ? `<div><span class="text-gray-400">14天:</span> <span class="text-purple-400">${formatRate(coin.annualizedInterestRate14D)}</span></div>` : ''}
                                            ${coin.annualizedInterestRate30D ? `<div><span class="text-gray-400">30天:</span> <span class="text-purple-400">${formatRate(coin.annualizedInterestRate30D)}</span></div>` : ''}
                                            ${coin.annualizedInterestRate60D ? `<div><span class="text-gray-400">60天:</span> <span class="text-purple-400">${formatRate(coin.annualizedInterestRate60D)}</span></div>` : ''}
                                            ${coin.annualizedInterestRate90D ? `<div><span class="text-gray-400">90天:</span> <span class="text-purple-400">${formatRate(coin.annualizedInterestRate90D)}</span></div>` : ''}
                                            ${coin.annualizedInterestRate180D ? `<div><span class="text-gray-400">180天:</span> <span class="text-purple-400">${formatRate(coin.annualizedInterestRate180D)}</span></div>` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="bg-gray-700 rounded p-3 mt-3">
                            <div class="flex justify-between">
                                <span class="text-gray-400">最大借币量:</span>
                                <span class="text-yellow-400 font-semibold">${coin.maxBorrowingAmount}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateStats(data) {
            const totalCoins = data.length;
            const flexibleCoins = data.filter(coin => coin.flexibleBorrowable).length;
            const fixedCoins = data.filter(coin => coin.fixedBorrowable).length;

            document.getElementById('totalCoins').textContent = totalCoins;
            document.getElementById('flexibleCoins').textContent = flexibleCoins;
            document.getElementById('fixedCoins').textContent = fixedCoins;
        }

        function renderData(data) {
            const container = document.getElementById('dataContainer');
            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');
            const statsContainer = document.getElementById('statsContainer');

            loadingContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-20">
                        <svg class="w-16 h-16 mx-auto text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <p class="text-gray-400 text-lg">暂无数据</p>
                    </div>
                `;
                statsContainer.classList.add('hidden');
            } else {
                container.innerHTML = data.map(coin => renderCoinCard(coin)).join('');
                updateStats(data);
                statsContainer.classList.remove('hidden');
            }
            
            container.classList.remove('hidden');
            
            const now = new Date();
            document.getElementById('lastUpdate').textContent = `最后更新: ${now.toLocaleTimeString('zh-CN')}`;
        }

        function showError(message) {
            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            const dataContainer = document.getElementById('dataContainer');
            const statsContainer = document.getElementById('statsContainer');

            loadingContainer.classList.add('hidden');
            dataContainer.classList.add('hidden');
            statsContainer.classList.add('hidden');
            errorContainer.classList.remove('hidden');
            errorMessage.textContent = message;
            
            document.getElementById('statusIndicator').classList.remove('bg-green-500');
            document.getElementById('statusIndicator').classList.add('bg-red-500');
        }

        async function updateData() {
            try {
                document.getElementById('statusIndicator').classList.remove('bg-green-500', 'bg-red-500');
                document.getElementById('statusIndicator').classList.add('bg-yellow-500');
                
                const vipLevel = document.getElementById('vipLevel').value;
                const data = await fetchLoanData(vipLevel);
                allCoinsData = data;
                
                if (fundingRateData.length > 0) {
                    const arbitrageCoins = checkArbitrageOpportunities(fundingRateData, data);
                    if (arbitrageCoins.length > 0) {
                        showArbitrageAlert(arbitrageCoins);
                    }
                }
                
                applyFilters();
                
                document.getElementById('statusIndicator').classList.remove('bg-yellow-500');
                document.getElementById('statusIndicator').classList.add('bg-green-500');
            } catch (error) {
                showError(`获取数据失败: ${error.message}`);
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.trim().toUpperCase();
            let filteredData = allCoinsData;
            
            if (searchTerm) {
                filteredData = allCoinsData.filter(coin => 
                    coin.currency.toUpperCase().includes(searchTerm)
                );
            }
            
            if (currentSortOrder) {
                filteredData = sortByInterestRate(filteredData, currentSortOrder);
            }
            
            renderData(filteredData);
        }
        
        function sortByInterestRate(data, order) {
            return [...data].sort((a, b) => {
                const rateA = parseFloat(a.flexibleAnnualizedInterestRate) || 0;
                const rateB = parseFloat(b.flexibleAnnualizedInterestRate) || 0;
                
                if (order === 'asc') {
                    return rateA - rateB;
                } else if (order === 'desc') {
                    return rateB - rateA;
                }
                return 0;
            });
        }
        
        function updateSortButtons() {
            const sortAscBtn = document.getElementById('sortAsc');
            const sortDescBtn = document.getElementById('sortDesc');
            const sortResetBtn = document.getElementById('sortReset');
            
            sortAscBtn.classList.remove('bg-blue-600', 'border-blue-500');
            sortDescBtn.classList.remove('bg-blue-600', 'border-blue-500');
            sortResetBtn.classList.remove('bg-blue-600', 'border-blue-500');
            
            sortAscBtn.classList.add('bg-gray-700', 'border-gray-600');
            sortDescBtn.classList.add('bg-gray-700', 'border-gray-600');
            sortResetBtn.classList.add('bg-gray-700', 'border-gray-600');
            
            if (currentSortOrder === 'asc') {
                sortAscBtn.classList.remove('bg-gray-700', 'border-gray-600');
                sortAscBtn.classList.add('bg-blue-600', 'border-blue-500');
            } else if (currentSortOrder === 'desc') {
                sortDescBtn.classList.remove('bg-gray-700', 'border-gray-600');
                sortDescBtn.classList.add('bg-blue-600', 'border-blue-500');
            } else {
                sortResetBtn.classList.remove('bg-gray-700', 'border-gray-600');
                sortResetBtn.classList.add('bg-blue-600', 'border-blue-500');
            }
        }

        document.getElementById('refreshBtn').addEventListener('click', updateData);
        
        document.getElementById('vipLevel').addEventListener('change', () => {
            updateData();
        });
        
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearch');
        
        searchInput.addEventListener('input', (e) => {
            const value = e.target.value;
            if (value) {
                clearSearchBtn.classList.remove('hidden');
            } else {
                clearSearchBtn.classList.add('hidden');
            }
            applyFilters();
        });
        
        clearSearchBtn.addEventListener('click', () => {
            searchInput.value = '';
            clearSearchBtn.classList.add('hidden');
            applyFilters();
        });
        
        document.getElementById('sortAsc').addEventListener('click', () => {
            currentSortOrder = 'asc';
            updateSortButtons();
            applyFilters();
        });
        
        document.getElementById('sortDesc').addEventListener('click', () => {
            currentSortOrder = 'desc';
            updateSortButtons();
            applyFilters();
        });
        
        document.getElementById('sortReset').addEventListener('click', () => {
            currentSortOrder = null;
            updateSortButtons();
            applyFilters();
        });

        function startAutoUpdate() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            updateInterval = setInterval(updateData, UPDATE_INTERVAL);
        }

        document.getElementById('closeArbitrageAlert').addEventListener('click', () => {
            document.getElementById('arbitrageAlert').classList.add('hidden');
        });
        
        document.getElementById('wsConnect').addEventListener('click', connectWebSocket);
        
        document.getElementById('wsDisconnect').addEventListener('click', disconnectWebSocket);
        
        document.getElementById('wsUrl').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connectWebSocket();
            }
        });
        
        document.getElementById('pushType').addEventListener('change', (e) => {
            const type = e.target.value;
            const webhookTypeDiv = document.getElementById('webhookTypeDiv');
            const customKeywordDiv = document.getElementById('customKeywordDiv');
            const wsKeywordDiv = document.getElementById('wsKeywordDiv');
            const wsAutoReconnectDiv = document.getElementById('wsAutoReconnectDiv');
            const urlHint = document.getElementById('urlHint');
            const urlInput = document.getElementById('wsUrl');
            
            if (type === 'webhook') {
                webhookTypeDiv.classList.remove('hidden');
                customKeywordDiv.classList.remove('hidden');
                wsKeywordDiv.classList.add('hidden');
                wsAutoReconnectDiv.classList.add('hidden');
                urlHint.textContent = '钉钉机器人 Webhook 地址';
                urlInput.placeholder = 'https://oapi.dingtalk.com/robot/send?access_token=...';
            } else {
                webhookTypeDiv.classList.add('hidden');
                customKeywordDiv.classList.add('hidden');
                wsKeywordDiv.classList.remove('hidden');
                wsAutoReconnectDiv.classList.remove('hidden');
                urlHint.textContent = 'WebSocket 服务器地址';
                urlInput.placeholder = 'ws://localhost:8080 或 wss://your-server.com/ws';
            }
        });
        
        document.getElementById('webhookType').addEventListener('change', (e) => {
            const type = e.target.value;
            const urlHint = document.getElementById('urlHint');
            const urlInput = document.getElementById('wsUrl');
            
            switch(type) {
                case 'dingtalk':
                    urlHint.textContent = '钉钉机器人 Webhook 地址';
                    urlInput.placeholder = 'https://oapi.dingtalk.com/robot/send?access_token=...';
                    break;
                case 'wecom':
                    urlHint.textContent = '企业微信机器人 Webhook 地址';
                    urlInput.placeholder = 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=...';
                    break;
                case 'feishu':
                    urlHint.textContent = '飞书机器人 Webhook 地址';
                    urlInput.placeholder = 'https://open.feishu.cn/open-apis/bot/v2/hook/...';
                    break;
                case 'custom':
                    urlHint.textContent = '自定义 Webhook 地址';
                    urlInput.placeholder = 'https://your-server.com/webhook';
                    break;
            }
        });
        
        document.getElementById('testPush').addEventListener('click', async () => {
            const testMessage = '这是一条测试消息，用于验证推送配置是否正常工作。';
            const button = document.getElementById('testPush');
            const originalText = button.textContent;
            
            button.disabled = true;
            button.textContent = '发送中...';
            
            if (!pushEnabled) {
                wsLog('请先启用推送', 'error');
                button.disabled = false;
                button.textContent = originalText;
                return;
            }
            
            const success = await sendWebSocketMessage(testMessage);
            
            setTimeout(() => {
                button.disabled = false;
                button.textContent = originalText;
            }, 2000);
        });
        
        document.getElementById('arbitrageThreshold').addEventListener('change', (e) => {
            const value = parseFloat(e.target.value);
            if (value > 0) {
                e.target.value = '0';
                wsLog('阈值必须为负数或 0', 'error');
            }
            arbitrageThreshold = parseFloat(e.target.value) / 100;
            wsLog(`套利阈值已设置为: ${e.target.value}%`, 'success');
        });
        
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
        });
        
        document.getElementById('pushType').dispatchEvent(new Event('change'));
        
        updateData();
        startAutoUpdate();
        
        updateFundingRates();
        fundingRateInterval = setInterval(updateFundingRates, UPDATE_INTERVAL);
    </script>
</body>
</html>
